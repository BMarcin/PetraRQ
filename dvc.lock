schema: '2.0'
stages:
  split_dataset:
    cmd: python ./src/split_dataset.py
    deps:
    - path: ./data/in-header.tsv
      md5: 691f892e65c64cefe6e4bfb1493a997a
      size: 24
    - path: ./data/out-header.tsv
      md5: dc6c1d3eecfe40d374314b5d56aa536d
      size: 14
    - path: ./data/parsed_books.json
      md5: 9576a6183ea8650d4532f5ecf609543d
      size: 3551043806
    - path: ./src/DatasetSplitter/DatasetSplitter.py
      md5: 74decfd061dccc1e8e9f604ede9ea119
      size: 2254
    - path: ./src/split_dataset.py
      md5: d8e77a6d76dcb4bc9a1afa79c1c93112
      size: 4088
    params:
      params.yaml:
        datasetsplit.dev: 0.05
        datasetsplit.sort_by: date
        datasetsplit.test: 0.1
        datasetsplit.train: 0.85
    outs:
    - path: ./data/dev/expected.tsv
      md5: dc4a2f2afd01b1ae6d8558e9203098ff
      size: 27834
    - path: ./data/dev/in.tsv
      md5: cf8988a50fb98773c4b35e83ce6c181d
      size: 140765244
    - path: ./data/test/expected.tsv
      md5: 57c027755b2a56ef8d7a0ad954e0e315
      size: 51063
    - path: ./data/test/in.tsv
      md5: 96ff97b1860898735276dfd5987c857c
      size: 233295323
    - path: ./data/train/expected.tsv
      md5: ffd1cdc52531dd3f0eca78f99e800c5b
      size: 494681
    - path: ./data/train/in.tsv
      md5: d3101db282e8db278f3ab90858ff547e
      size: 2591641657
  rewrite_dataset_to_lm_texts:
    cmd: python ./src/rewrite_dataset.py
    deps:
    - path: ./data/dev/in.tsv
      md5: dafa7c488580f29a63431ce149d6416d
      size: 239789657
    - path: ./data/test/in.tsv
      md5: 965f5c51903a86b4627d19a578eaa5b4
      size: 388966317
    - path: ./data/train/in.tsv
      md5: a2d8dfd76ceed3e0278f714429cd1fd1
      size: 2621612493
    - path: ./src/DatasetRewriter/LanguageModelingRewriter.py
      md5: da1e1d32ff54803854ca0fbb0b7054b4
      size: 1532
    - path: ./src/rewrite_dataset.py
      md5: 2feb4ef0cb9eaec8bf89af21690d4ffb
      size: 2006
    outs:
    - path: ./data/dev/lm.txt
      md5: 3ded16b3953922cceaa90923883a7147
      size: 215738076
      isexec: true
    - path: ./data/dev/processed.tsv
      md5: 3ded16b3953922cceaa90923883a7147
      size: 215738076
      isexec: true
    - path: ./data/test/lm.txt
      md5: 61ed2915525aa2acd50189a964ddc46a
      size: 348233057
      isexec: true
    - path: ./data/test/processed.tsv
      md5: 61ed2915525aa2acd50189a964ddc46a
      size: 348233057
      isexec: true
    - path: ./data/train/lm.txt
      md5: 5928e0910854642a694527f5d062f636
      size: 2391144197
      isexec: true
    - path: ./data/train/processed.tsv
      md5: 5928e0910854642a694527f5d062f636
      size: 2391144197
      isexec: true
  train_lm:
    cmd: python ./src/train_roberta_lm.py
    deps:
    - path: ./data/dev/lm.txt
      md5: 3ded16b3953922cceaa90923883a7147
      size: 215738076
    - path: ./data/labels.tsv
      md5: e16bcdbc2b4c6c92d285156fd0cfd011
      size: 254
    - path: ./data/test/lm.txt
      md5: 61ed2915525aa2acd50189a964ddc46a
      size: 348233057
    - path: ./data/train/lm.txt
      md5: 5928e0910854642a694527f5d062f636
      size: 2391144197
    - path: ./src/train_roberta_lm.py
      md5: bf9791f613267cfe36918ea14d9b798a
      size: 5095
    params:
      params.yaml:
        language_modeling_train.epochs: 200
        language_modeling_train.hidden_dropout_prob: 0.1
        language_modeling_train.hidden_size: 768
        language_modeling_train.max_seq_length: 512
        language_modeling_train.mlm_probability: 0.15
        language_modeling_train.num_attention_heads: 12
        language_modeling_train.num_hidden_layers: 12
        language_modeling_train.seed: 42
        language_modeling_train.tokenizer_min_frequency: 2
        language_modeling_train.vocab_size: 16000
    outs:
    - path: ./models/roberta_lm/config.json
      md5: fb932332aa81d1ad848d0889dabb64ec
      size: 637
    - path: ./models/roberta_lm/merges.txt
      md5: cec421c01956b7d8ae22cc754331a35f
      size: 145988
    - path: ./models/roberta_lm/pytorch_model.bin
      md5: f4e4219fa51a2ea7c3e199878ab9cb3d
      size: 393462571
    - path: ./models/roberta_lm/special_tokens_map.json
      md5: 30d0b45671f60afbb09abb28d04fcfa4
      size: 845
    - path: ./models/roberta_lm/tokenizer.json
      md5: 02a064b4f397df62600c55adeb4c0e81
      size: 666006
    - path: ./models/roberta_lm/tokenizer_config.json
      md5: a22d94c14d5cc34c59e5b4ad42506208
      size: 1155
    - path: ./models/roberta_lm/vocab.json
      md5: c089e0d5dd42b586b543d468552b5430
      size: 247826
    - path: scores.json
      md5: 0cb723a1d2ee842704be485dbe90f5a3
      size: 74
  train_classifier:
    cmd: python ./src/train_petrarq_classifier.py
    deps:
    - path: ./data/dev/expected.tsv
      md5: dc4a2f2afd01b1ae6d8558e9203098ff
      size: 27834
    - path: ./data/dev/in.tsv
      md5: cf8988a50fb98773c4b35e83ce6c181d
      size: 140765244
    - path: ./data/labels.tsv
      md5: 450f79a3a1c0c777916a661ed07960ea
      size: 351
    - path: ./data/test/expected.tsv
      md5: 57c027755b2a56ef8d7a0ad954e0e315
      size: 51063
    - path: ./data/test/in.tsv
      md5: 96ff97b1860898735276dfd5987c857c
      size: 233295323
    - path: ./data/train/expected.tsv
      md5: ffd1cdc52531dd3f0eca78f99e800c5b
      size: 494681
    - path: ./data/train/in.tsv
      md5: d3101db282e8db278f3ab90858ff547e
      size: 2591641657
    - path: ./src/PetraRQ/ClassificationDataset.py
      md5: 090fd8efdb508f944e5de1f31300548f
      size: 2667
    - path: ./src/PetraRQ/CollateFunction.py
      md5: 74d30a02ee37115bdc56633d9ab58f6d
      size: 927
    - path: ./src/PetraRQ/PetraRQ.py
      md5: 784f8736822505ca6034ff5031c3a877
      size: 7921
    - path: ./src/train_petrarq_classifier.py
      md5: 183216c28804348ea4da4b7807e1d335
      size: 8285
    params:
      params.yaml:
        classification_train.epochs: 2
        classification_train.increase_each: 0.1
        classification_train.lr: 0.001
        classification_train.num_training_samples: -1
        classification_train.overlapping_part: 256
        classification_train.seed: 42
        classification_train.seq_length: 512
        classification_train.train_batch_size: 16
    outs:
    - path: ./models/petrarq_classifier_books/pytorch_model.ckpt
      md5: 3cc3c0b5e800bc44cb95ee21ab49d5a5
      size: 1157684303
  evaluate_classifier:
    cmd: python ./src/eval.py
    deps:
    - path: ./models/petrarq_classifier_books/pytorch_model.ckpt
      md5: 3cc3c0b5e800bc44cb95ee21ab49d5a5
      size: 1157684303
    - path: ./src/eval.py
      md5: 2e977cb3f6ca3f28a76f73013e78eb9b
      size: 9969
    params:
      params.yaml:
        classification_eval.epsilon: 0.01
    outs:
    - path: ./data/dev/out.tsv
      md5: ebd6cf062bc5c573a153cd89b2ef8511
      size: 855872
    - path: ./data/test/out.tsv
      md5: 9ddd485c070deea436c4ac38b3adf61d
      size: 1682160
    - path: scores_classification.json
      md5: 56c4ef92ec0c03e511fd5683f751d598
      size: 79
